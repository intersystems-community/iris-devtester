# API Contract: CLI Commands
# Feature: 004-dat-fixtures
# Date: 2025-10-14

contract:
  name: FixtureCLI
  description: Command-line interface for .DAT fixture management
  module: iris_devtools.cli.fixture_commands
  framework: click

commands:
  - name: fixture create
    signature: fixture create --name NAME --namespace NAMESPACE --output DIR [OPTIONS]
    description: Create .DAT fixture by exporting IRIS namespace
    arguments:
      - name: --name
        type: str
        required: true
        description: Fixture identifier (e.g., "test-entities-100")
      - name: --namespace
        type: str
        required: true
        description: Source namespace to export (e.g., "USER_TEST_100")
      - name: --output
        type: str
        required: true
        description: Output directory for fixture
      - name: --description
        type: str
        required: false
        description: Human-readable description
      - name: --version
        type: str
        required: false
        default: "1.0.0"
        description: Semantic version
      - name: --verbose
        type: bool
        required: false
        flag: true
        description: Show detailed progress
    output:
      success: |
        ✅ Fixture created: {fixture_id}

        Location: {output_dir}
        Tables: {table_count}
        Total rows: {total_rows}
        Size: {size_mb:.2f} MB
        Time: {elapsed_seconds:.2f}s

        Next steps:
          1. Validate: iris-devtools fixture validate --fixture {output_dir}
          2. Load: iris-devtools fixture load --fixture {output_dir}
          3. Commit to git: git add {output_dir}
      failure: |
        ❌ Failed to create fixture

        What went wrong:
          {error_details}

        How to fix it:
          {fix_instructions}
    exit_codes:
      0: Success
      1: Invalid arguments
      2: Namespace not found
      3: Backup failed
      4: Connection error
    examples:
      - description: Create fixture from namespace
        command: iris-devtools fixture create --name test-100 --namespace USER_TEST_100 --output ./fixtures/test-100 --description "100 test entities"
      - description: Create fixture with version
        command: iris-devtools fixture create --name rag-full --namespace RAG_PRODUCTION --output ./fixtures/rag-full --version 2.0.0

  - name: fixture load
    signature: fixture load --fixture PATH [OPTIONS]
    description: Load .DAT fixture into IRIS database
    arguments:
      - name: --fixture
        type: str
        required: true
        description: Path to fixture directory
      - name: --namespace
        type: str
        required: false
        description: Target namespace for mounting (default: uses manifest's namespace)
      - name: --no-validate
        type: bool
        required: false
        flag: true
        description: Skip IRIS.DAT checksum validation (faster, less safe)
      - name: --verbose
        type: bool
        required: false
        flag: true
        description: Show detailed progress
    output:
      success: |
        ✅ Fixture loaded: {fixture_id}

        Namespace: {namespace}
        Tables loaded: {table_count}
        Total rows: {total_rows}
        Time: {elapsed_seconds:.2f}s

        Tables:
          {table_list}

        Next steps:
          Run your tests or query the data
      failure: |
        ❌ Failed to load fixture

        What went wrong:
          {error_details}

        How to fix it:
          {fix_instructions}

        Note: Namespace mount is atomic (all-or-nothing operation)
    exit_codes:
      0: Success
      1: Fixture not found
      2: Checksum validation failure
      3: Namespace already exists
      4: Mount failed
      5: Connection error
    examples:
      - description: Load fixture with default settings
        command: iris-devtools fixture load --fixture ./fixtures/test-100
      - description: Load to custom namespace with validation
        command: iris-devtools fixture load --fixture ./fixtures/test-100 --namespace TESTNS
      - description: Fast load without checksum validation
        command: iris-devtools fixture load --fixture ./fixtures/test-100 --no-validate

  - name: fixture validate
    signature: fixture validate --fixture PATH [OPTIONS]
    description: Validate fixture integrity (manifest, files, checksums)
    arguments:
      - name: --fixture
        type: str
        required: true
        description: Path to fixture directory
      - name: --no-checksums
        type: bool
        required: false
        flag: true
        description: Skip checksum validation (faster)
      - name: --recalc
        type: bool
        required: false
        flag: true
        description: Recalculate checksums and update manifest
      - name: --verbose
        type: bool
        required: false
        flag: true
        description: Show detailed validation results
    output:
      success: |
        ✅ Fixture is valid: {fixture_id}

        Fixture: {fixture_id}
        Version: {version}
        Schema: {schema_version}
        Tables: {table_count}
        Total rows: {total_rows}
        Size: {size_mb:.2f} MB

        Tables:
          {table_list}

        {warnings}
      failure: |
        ❌ Fixture validation failed

        Errors:
          {error_list}

        Warnings:
          {warning_list}

        How to fix it:
          {fix_instructions}
    exit_codes:
      0: Valid
      1: Validation failed
      2: Fixture not found
    examples:
      - description: Validate fixture with checksums
        command: iris-devtools fixture validate --fixture ./fixtures/test-100
      - description: Fast validation (skip checksums)
        command: iris-devtools fixture validate --fixture ./fixtures/test-100 --no-checksums
      - description: Recalculate checksums
        command: iris-devtools fixture validate --fixture ./fixtures/test-100 --recalc

  - name: fixture list
    signature: fixture list [PATH] [OPTIONS]
    description: List available fixtures in directory
    arguments:
      - name: path
        type: str
        required: false
        default: "./fixtures"
        description: Directory to search for fixtures
      - name: --verbose
        type: bool
        required: false
        flag: true
        description: Show detailed fixture info
    output:
      success: |
        Available fixtures in {path}:

        {fixture_list}

        Total: {fixture_count} fixtures, {total_size_mb:.2f} MB
      empty: |
        No fixtures found in {path}

        To create a fixture:
          iris-devtools fixture create --name my-fixture --tables MyTable --output {path}/my-fixture
    exit_codes:
      0: Success
      1: Directory not found
    examples:
      - description: List fixtures in default directory
        command: iris-devtools fixture list
      - description: List fixtures in custom directory
        command: iris-devtools fixture list ./test-data/fixtures
      - description: List with detailed info
        command: iris-devtools fixture list --verbose

  - name: fixture info
    signature: fixture info --fixture PATH
    description: Show detailed information about fixture
    arguments:
      - name: --fixture
        type: str
        required: true
        description: Path to fixture directory
      - name: --json
        type: bool
        required: false
        flag: true
        description: Output as JSON
    output:
      success: |
        Fixture: {fixture_id}
        Version: {version}
        Description: {description}
        Created: {created_at}
        IRIS Version: {iris_version}
        Schema Version: {schema_version}

        Tables ({table_count}):
          {table_details}

        Size:
          Total: {total_size_mb:.2f} MB
          Manifest: {manifest_size_kb:.2f} KB
          DAT files: {dat_size_mb:.2f} MB

        {features}

        {known_queries}

        Location: {fixture_path}
      json_output: |
        {
          "fixture_id": "...",
          "version": "...",
          "description": "...",
          "tables": [...],
          "size": {...}
        }
    exit_codes:
      0: Success
      1: Fixture not found
    examples:
      - description: Show fixture info
        command: iris-devtools fixture info --fixture ./fixtures/test-100
      - description: Output as JSON for scripting
        command: iris-devtools fixture info --fixture ./fixtures/test-100 --json

global_options:
  - name: --help
    description: Show help message and exit
  - name: --version
    description: Show iris-devtools version

progress_indicators:
  create:
    - "Connecting to IRIS..."
    - "Exporting table {table_name} ({current}/{total})..."
    - "Calculating checksums..."
    - "Writing manifest..."
  load:
    - "Validating fixture..."
    - "Validating checksums ({current}/{total})..."
    - "Loading table {table_name} ({current}/{total})..."
    - "Committing transaction..."
  validate:
    - "Loading manifest..."
    - "Checking files..."
    - "Validating checksums ({current}/{total})..."

error_messages:
  connection_failed: |
    Failed to connect to IRIS

    What went wrong:
      Could not establish connection to IRIS database

    How to fix it:
      1. Start IRIS: docker-compose up -d
      2. Wait 30 seconds for startup
      3. Verify connection: iris-devtools connection test
      4. Check environment variables: env | grep IRIS
  table_not_found: |
    Table not found: {table_name}

    What went wrong:
      The specified table does not exist in namespace {namespace}

    How to fix it:
      1. List available tables: iris-devtools schema list-tables
      2. Check namespace: iris-devtools connection info
      3. Verify table name spelling (case-sensitive)
  checksum_mismatch: |
    Checksum mismatch for {file_path}

    What went wrong:
      File checksum: {actual_checksum}
      Expected:      {expected_checksum}
      The .DAT file may be corrupted or modified

    How to fix it:
      1. Re-download or re-create the fixture
      2. Check disk integrity: fsck / CHKDSK
      3. Recalculate checksums: iris-devtools fixture validate --recalc {fixture_path}

color_output:
  success: green
  error: red
  warning: yellow
  info: cyan
  progress: blue

testing:
  contract_tests: tests/contract/test_cli_fixture_commands.py
  integration_tests: tests/integration/test_cli_integration.py
  e2e_tests: tests/e2e/test_fixture_workflow.py

dependencies:
  - click>=8.0.0 - CLI framework
  - iris_devtools.fixtures.loader - DATFixtureLoader
  - iris_devtools.fixtures.creator - FixtureCreator
  - iris_devtools.fixtures.validator - FixtureValidator

constitutional_compliance:
  principle_4: Zero configuration (auto-discovers IRIS connection)
  principle_5: Fail fast with guidance (structured error messages with fix instructions)
  principle_7: Medical-grade reliability (checksum validation, atomic operations)
